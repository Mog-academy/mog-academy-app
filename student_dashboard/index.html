<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mo.G Academy — Registration Confirmed</title>

  <style>
    :root{
      --orange:#ff9e0c;
      --black:#111111;
      --muted:#7a7a7a;
      --line:#e9e9e9;
      --soft:#fafafa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100vh;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: var(--orange);
      color: var(--black);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px 18px;
    }
    .shell{
      width: min(920px, 100%);
      background:#fff;
      border-radius: 28px;
      border: 2px solid rgba(17,17,17,0.08);
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:16px 20px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo-link{
      display:inline-flex;
      align-items:center;
      text-decoration:none;
      color:inherit;
    }
    .logo-img{
      width:46px;
      height:46px;
      border-radius: 12px;
      border:1px solid rgba(17,17,17,0.10);
      background:#fff;
      object-fit:contain;
      padding:6px;
      transition: 0.18s ease;
    }
    .logo-link:hover .logo-img{ transform: translateY(-1px); }
    .brandtxt .name{
      font-weight:600;
      font-size:15px;
      line-height:1.1;
      letter-spacing:0.2px;
    }

    .content{ padding: 34px 22px 26px; background:#fff; }
    .card{
      border:1px solid var(--line);
      border-radius: 22px;
      background:#fff;
      padding: 28px 18px 22px;
    }
    .center{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:14px;
      padding: 10px 6px 6px;
    }
    .hero{
      margin:0;
      font-size: 26px;
      line-height:1.15;
      letter-spacing: 0.4px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .message{
      margin:0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
      max-width: 62ch;
      font-weight: 400;
    }

    .social-wrap{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      flex-wrap:wrap;
      margin-top: 4px;
    }
    .follow-text{
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
      white-space: nowrap;
    }
    .social-row{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .social-icon{
      width:44px;
      height:44px;
      border-radius: 999px;
      overflow:hidden;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      background: transparent;
    }
    .social-icon img{
      width:44px;
      height:44px;
      object-fit:cover;
      border-radius: 999px;
      display:block;
    }
    .social-icon:focus{
      outline: 3px solid rgba(255,158,12,0.45);
      outline-offset: 4px;
      border-radius: 999px;
    }

    .mini{
      width:100%;
      text-align:center;
      font-size:12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .mini b{ color: var(--black); font-weight:600; }

    .cert-wrap{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      width:100%;
    }
    .btn{
      border:1px solid rgba(17,17,17,0.14);
      background:#111;
      color:#fff;
      padding:11px 14px;
      border-radius:14px;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      transition:0.18s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{ opacity:0.55; cursor:not-allowed; transform:none; }

    .status{
      width:100%;
      text-align:center;
      color: var(--muted);
      font-size: 13px;
      line-height:1.55;
      min-height: 18px;
    }

    .debug{
      width:100%;
      max-width: 780px;
      margin-top: 10px;
      text-align:left;
      font-size:12px;
      line-height:1.5;
      color:#6f6f6f;
      background: var(--soft);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      white-space:pre-wrap;
      overflow:auto;
    }

    .footer{
      padding: 14px 20px 18px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      background:#fff;
      font-weight:400;
    }
    .footer a{
      color: var(--black);
      font-weight: 600;
      text-decoration:none;
      border-bottom:1px solid rgba(17,17,17,0.18);
      padding-bottom:2px;
    }

    @media (max-width: 600px){
      .hero{font-size:22px}
      .card{padding: 22px 14px 18px}
      .social-icon, .social-icon img{width:42px;height:42px}
      .follow-text{white-space: normal; text-align:center}
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <a class="logo-link" href="https://mog-academy.com" aria-label="Go to Mo.G Academy homepage">
          <img class="logo-img" src="logo.png" alt="Mo.G Academy logo" />
        </a>
        <div class="brandtxt">
          <div class="name">Mo.G Academy</div>
        </div>
      </div>
      <div style="width:46px;height:46px;"></div>
    </div>

    <div class="content">
      <div class="card">
        <div class="center">
          <h1 class="hero">Registration confirmed!</h1>

          <p class="message">
            Thank you for registering! Your account and voucher will be ready once the website is launched, stay tuned!
          </p>

          <div class="social-wrap" aria-label="Social media links">
            <div class="follow-text">Follow us on social media to stay updated:</div>
            <div class="social-row">
              <a class="social-icon" href="https://www.linkedin.com" target="_blank" rel="noopener" aria-label="Mo.G Academy on LinkedIn">
                <img src="linkedin.png" alt="" />
              </a>
              <a class="social-icon" href="https://www.instagram.com" target="_blank" rel="noopener" aria-label="Mo.G Academy on Instagram">
                <img src="instagram.png" alt="" />
              </a>
              <a class="social-icon" href="https://www.youtube.com" target="_blank" rel="noopener" aria-label="Mo.G Academy on YouTube">
                <img src="youtube.png" alt="" />
              </a>
            </div>
          </div>

          <div class="mini" id="whoami">Signed in as: <b>checking…</b></div>

          <div class="cert-wrap">
            <button id="downloadCertBtn" class="btn" type="button" style="display:none;">
              Download certificate
            </button>
            <div id="certStatus" class="status"></div>
          </div>

          <div id="debug" class="debug">Booting…</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>© <span id="y"></span> Mo.G Academy</div>
      <div><a href="https://mog-academy.com">mog-academy.com</a></div>
    </div>
  </div>

  <!-- Hidden certificate render target -->
<div id="certificate"
     style="
      width:1200px;height:850px;
      background:#fff;
      border:12px solid #ff9e0c;
      padding:70px 80px 64px;
      font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;
      color:#111;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
     ">

  <!-- Top centered logo only -->
  <div style="display:flex;justify-content:center;align-items:center;">
    <img id="certLogo"
         src="logo.png"
         alt="Mo.G Academy logo"
         crossorigin="anonymous"
         style="
          width:240px;
          height:auto;
          object-fit:contain;
          display:block;
         " />
  </div>

  <!-- Hidden fields required by your JS (do not remove) -->
  <div style="position:absolute; left:-99999px; top:0; width:1px; height:1px; overflow:hidden;">
    <span id="certEmail"></span>
    <span id="certFullName"></span>
  </div>

  <!-- Header -->
  <div style="margin-top:38px;text-align:center;">
    <div style="font-size:48px;font-weight:800;letter-spacing:1.6px;text-transform:uppercase;">
      Certificate of Completion
    </div>

    <div style="margin-top:46px;font-size:14px;color:#7a7a7a;letter-spacing:0.2px;">
      This certifies that
    </div>

    <div id="certStudentName"
         style="
          margin-top:18px;
          font-size:42px;
          font-weight:800;
          letter-spacing:0.2px;
          line-height:1.15;
         ">
      Full Name
    </div>

    <div style="margin-top:18px;font-size:18px;font-weight:700;">
      <span id="certCourseTitle">D5 User Certification Training Program</span>
    </div>
  </div>

  <!-- Main paragraph (flex item) -->
  <div style="margin-top:52px;display:flex;justify-content:center;flex:1;">
    <div style="
      max-width: 880px;
      text-align:center;
      font-size:16px;
      line-height:1.9;
      color:#555;
      letter-spacing:0.1px;
      align-self:center;
    ">
      This certificate proudly recognizes the successful completion of the program requirements, representing a total of
      <b><span id="certHours">14 hours</span></b>
      of structured training concluded on
      <b><span id="certDate">January 25, 2026</span></b>,
      and warmly congratulates the participant on this achievement, acknowledging their dedication and effort while noting
      their affiliation with the company <b><span id="certCompany">Calcium</span></b> and their fulfillment of all the necessary
      criteria for formal recognition.
    </div>
  </div>

  <!-- Footer (always at bottom, no overlap) -->
  <div style="
    margin-top:auto;
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:40px;
  ">
    <div>
      <div style="font-size:12px;color:#7a7a7a;margin-bottom:8px;">Instructor</div>
      <div id="certInstructor" style="font-size:16px;font-weight:800;">Mohamed Elgaili</div>
    </div>

    <div style="text-align:right;min-width:260px;">
      <img id="certSign"
           src="mysign.png"
           alt="Instructor signature"
           crossorigin="anonymous"
           style="
            height:72px;
            width:auto;
            object-fit:contain;
            display:block;
            margin-left:auto;
           " />
      <div style="margin-top:10px;font-size:12px;color:#7a7a7a;">Signature</div>
    </div>
  </div>

</div>




  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();

    // =========================
    // CONFIG
    // =========================
    const SUPABASE_URL = "https://yijcnkcaibspxbpvmzhd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpamNua2NhaWJzcHhicHZtemhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjQ0MDksImV4cCI6MjA4NDUwMDQwOX0.NqsgzQ8z9UKahVdbjXp9-yA2Y5F3yFveaF9mLzAXLl4";

    const USER_TABLE = "profiles";     // unified full_name lives here
    const CERT_TABLE = "course_certificates";

    const COURSE_ID = "D5 User Certification Training Program";
    const COURSE_TITLE = "D5 User Certification Training Program";

    const btn = document.getElementById("downloadCertBtn");
    const statusEl = document.getElementById("certStatus");
    const whoamiEl = document.getElementById("whoami");
    const debugEl = document.getElementById("debug");

    function log(s){ debugEl.textContent += s + "\n"; }
    function setStatus(s){ statusEl.textContent = s || ""; }

    function fmtDate(d) {
      if (!d) return "";
      const dt = new Date(d + "T00:00:00");
      return dt.toLocaleDateString(undefined, { year:"numeric", month:"long", day:"numeric" });
    }

    function safeFileName(s) {
      return String(s || "student").replace(/[^\w\-]+/g, "_").slice(0, 80);
    }

    function bootFail(msg){
      whoamiEl.innerHTML = 'Signed in as: <b>error</b>';
      setStatus(msg);
      log("BOOT FAIL: " + msg);
    }

    async function withTimeout(promise, ms, label){
      let t;
      const timeout = new Promise((_, reject) => {
        t = setTimeout(() => reject(new Error(label + " timed out after " + ms + "ms")), ms);
      });
      try{
        return await Promise.race([promise, timeout]);
      } finally {
        clearTimeout(t);
      }
    }

    async function waitForImage(imgEl) {
      await new Promise((resolve) => {
        if (!imgEl) return resolve();

        if (!imgEl.getAttribute("crossorigin")) imgEl.setAttribute("crossorigin", "anonymous");

        const done = () => resolve();
        if (imgEl.complete && imgEl.naturalWidth > 0) return done();

        imgEl.onload = done;
        imgEl.onerror = done;

        const src = imgEl.getAttribute("src");
        if (src && !src.includes("?cb=")) imgEl.src = src + "?cb=" + Date.now();
      });
    }

    async function main(){
      debugEl.textContent = "";
      log("Domain: " + location.origin);
      setStatus("Checking certificate eligibility…");

      if (!window.supabase || !window.supabase.createClient) {
        bootFail("Supabase SDK did not load (CDN blocked). Try disabling ad-block or use another CDN.");
        return;
      }

      if (!SUPABASE_URL.includes("supabase.co") || !SUPABASE_ANON_KEY) {
        bootFail("Supabase keys are not set in this page.");
        return;
      }

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      log("Supabase SDK: loaded");

      const sessionRes = await withTimeout(supabase.auth.getSession(), 5000, "getSession");
      const session = sessionRes?.data?.session || null;
      log("Session exists: " + (session ? "yes" : "no"));

      const userRes = await withTimeout(supabase.auth.getUser(), 5000, "getUser");
      const user = userRes?.data?.user || null;

      log("User id: " + (user?.id || "null"));
      log("User email: " + (user?.email || "null"));

      if (!user) {
        whoamiEl.innerHTML = 'Signed in as: <b>not logged in on this page</b>';
        setStatus("No login session found on this page.");
        log("If you logged in on another subdomain, this page won’t see that session.");
        return;
      }

      whoamiEl.innerHTML = 'Signed in as: <b>' + (user.email || "unknown") + '</b>';

      // ✅ Profile is the ONLY name source
      const profileRes = await withTimeout(
        supabase.from(USER_TABLE).select("full_name,email").eq("id", user.id).maybeSingle(),
        7000,
        "profile query"
      );
      const profile = profileRes?.data || null;
      const profileErr = profileRes?.error || null;

      log("Profile table: " + USER_TABLE);
      log("Profile found: " + (profile ? "yes" : "no"));
      if (profileErr) log("Profile error: " + profileErr.message);

      if (!profile || !profile.full_name || !profile.full_name.trim()) {
        setStatus("Your profile is missing full_name. Please complete your registration profile.");
        return;
      }

      const fullName = profile.full_name.trim();
      const email = profile?.email || user.email || "—";

      // ✅ Certificate row: NO student_name column
      const certRes = await withTimeout(
        supabase
          .from(CERT_TABLE)
          .select("company,completion_date,hours,instructor_name,eligible,user_id,course_id")
          .eq("user_id", user.id)
          .eq("course_id", COURSE_ID)
          .maybeSingle(),
        7000,
        "certificate query"
      );

      const cert = certRes?.data || null;
      const certErr = certRes?.error || null;

      log("Cert table: " + CERT_TABLE);
      log("Cert found: " + (cert ? "yes" : "no"));
      if (certErr) log("Cert error: " + certErr.message);
      log("Eligible: " + (cert?.eligible ?? "null"));

      if (!cert) {
        setStatus("No certificate row found for your user + this course.");
        return;
      }
      if (!cert.eligible) {
        setStatus("Certificate not available yet (eligible=false).");
        return;
      }

      setStatus("");
      btn.style.display = "inline-flex";
      log("SUCCESS: Button shown.");

      const combinedData = {
        course_id: COURSE_ID,
        course_title: COURSE_TITLE,
        full_name: fullName,
        email: email,
        company: cert.company || "—",
        completion_date: cert.completion_date,
        hours: cert.hours,
        instructor_name: cert.instructor_name || "—"
      };

      function fillCertificateTemplate(row) {
        document.getElementById("certFullName").textContent = row.full_name || "—";
        document.getElementById("certEmail").textContent = row.email || "—";
        document.getElementById("certCompany").textContent = row.company || "—";
        document.getElementById("certDate").textContent = fmtDate(row.completion_date);
        document.getElementById("certHours").textContent = (row.hours ?? "") + " hours";
        document.getElementById("certInstructor").textContent = row.instructor_name || "—";
        document.getElementById("certCourseTitle").textContent = row.course_title || "—";
      }

      btn.addEventListener("click", async () => {
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = "Generating…";

        try{
          fillCertificateTemplate(combinedData);

          await waitForImage(document.getElementById("certLogo"));
          await waitForImage(document.getElementById("certSign"));

          const canvas = await html2canvas(document.getElementById("certificate"), {
            scale: 2,
            useCORS: true,
            allowTaint: false,
            backgroundColor: "#ffffff"
          });

          const imgData = canvas.toDataURL("image/png");
          const { jsPDF } = window.jspdf;

          const pdf = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();

          const imgWidth = pageWidth;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          const y = (pageHeight - imgHeight) / 2;

          pdf.addImage(imgData, "PNG", 0, y, imgWidth, imgHeight);

          const file = `MoG_Certificate_${safeFileName(combinedData.course_id)}_${safeFileName(combinedData.full_name)}.pdf`;
          pdf.save(file);
        } catch(e){
          log("PDF error: " + e.message);
          setStatus("Could not generate the certificate. Check debug box.");
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    }

    main().catch(err => {
      bootFail("JS error: " + err.message);
    });
  </script>
</body>
</html>
